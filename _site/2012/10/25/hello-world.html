<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Calculating and plotting mapped reads - a simple R/shell script</title>
  <meta name="description" content="As this is my first post I&#39;ll start with something very simple I did recently. The problem is simple: &quot;how many reads did does my deep-seq experimen...">

  <link rel="stylesheet" href="/adomingues.github.io//css/main.css">
  <link rel="canonical" href="http://localhost:4000/adomingues.github.io//2012/10/25/hello-world.html">
  <link rel="alternate" type="application/rss+xml" title="Moving To The Dark Side" href="http://localhost:4000/adomingues.github.io//feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/adomingues.github.io//">Moving To The Dark Side</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/adomingues.github.io//about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Calculating and plotting mapped reads - a simple R/shell script</h1>
    <p class="post-meta">Oct 25, 2012</p>
  </header>

  <article class="post-content">
    <p>As this is my first post I&#39;ll start with something very simple I did recently. The problem is simple: &quot;how many reads did does my deep-seq experiment have and how many were mapped to the genome?&quot;. I am now dealing with several RNA-seq and ChIP-seq experiments and having a pipeline to get this info fast for several files is important to me.</p>

<p>There are several suggestion out there on how to it, but I wanted something that could be used routinely for several files per experiment, and that could output the results in a visual manner (and also a table).</p>

<p>Using SAMtools as suggested <a href="http://left.subtree.org/2012/04/13/counting-the-number-of-reads-in-a-bam-file/" title="Counting mapped reads">here</a> (thanks!) I&#39;ve started with a simple bash script that would output the mapped reads into a text file and possible do the maths:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#! /bin/bash</span>

<span class="c"># file header  </span>
<span class="nb">echo</span> <span class="s2">&quot;bam_file total mapped unmapped&quot;</span>

<span class="c"># loop to count reads in all files and add results to a table  </span>
<span class="k">for</span> bam_file in *.bam  
<span class="k">do</span>  
<span class="nv">total</span><span class="o">=</span><span class="k">$(</span>samtools view -c <span class="nv">$bam_file</span><span class="k">)</span>  
<span class="nv">mapped</span><span class="o">=</span><span class="k">$(</span>samtools view -c -F <span class="m">4</span> <span class="nv">$bam_file</span><span class="k">)</span>  
<span class="nv">unmapped</span><span class="o">=</span><span class="k">$(</span>samtools view -c -f <span class="m">4</span> <span class="nv">$bam_file</span><span class="k">)</span>  
<span class="nb">echo</span> <span class="s2">&quot;$bam_file $total $mapped $unmapped&quot;</span>  
<span class="k">done</span>  
<span class="c"># ultimately the data is saved in a space-separated file</span>

<span class="c"># saved in a file called &quot;CountMappedReads.sh&quot;</span></code></pre></div>

<p>Unfortunately arithmetic operations are not something advisable to do in shell - in my particular case because I am using a remote server without a necessary package. That minor setback led to think about doing in <a href="http://www.r-project.org/" title="R">R</a>: It can send commands to the shell; it is certainly built for mathematical/statistical operations and it has <a href="http://ggplot2.org/" title="ggplot2">ggplot</a>!</p>

<p>So this how the code looks like this:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># count reads using SAM tools  </span>
<span class="kn">library</span><span class="p">(</span>ggplot2<span class="p">)</span>  
<span class="kn">library</span><span class="p">(</span>reshape2<span class="p">)</span>  
<span class="kn">library</span><span class="p">(</span>plyr<span class="p">)</span>

<span class="c1"># function to call BAMtools and store reads count in a text file  </span>
CountReadsBAM <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">()</span>  
<span class="p">{</span>  
command<span class="o">=</span> <span class="s">&quot;~/bin/CountMappedReads.sh &gt; MappedReads.txt&quot;</span>  
<span class="kp">try</span><span class="p">(</span><span class="kp">system</span><span class="p">(</span>command<span class="p">))</span>  
res<span class="o">=</span>read.table<span class="p">(</span><span class="s">&quot;MappedReads.txt&quot;</span><span class="p">,</span> header<span class="o">=</span><span class="bp">T</span><span class="p">)</span>  
<span class="kr">return</span><span class="p">(</span>res<span class="p">)</span>  
<span class="p">}</span>

<span class="c1"># calling the funtion will output read count in an object:  </span>
ReadCount <span class="o">&lt;-</span> CountReadsBAM<span class="p">()</span>

<span class="c1"># a bit of polishing to remove total (not needed for plotting)  </span>
ReadCountSmall <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>BAM <span class="o">=</span> ReadCount<span class="o">$</span>bam_file<span class="p">,</span> Mapped <span class="o">=</span> ReadCount<span class="o">$</span>mapped<span class="p">,</span> Unmapped <span class="o">=</span> ReadCount<span class="o">$</span>unmapped<span class="p">)</span>

<span class="c1"># ggplot needs data in a specific layout  </span>
MeltedReadCount <span class="o">=</span> melt<span class="p">(</span>ReadCountSmall<span class="p">,</span> id<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="s">&#39;BAM&#39;</span><span class="p">))</span>  
<span class="kp">names</span><span class="p">(</span>MeltedReadCount<span class="p">)</span> <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="s">&#39;BAM&#39;</span><span class="p">,</span> <span class="s">&#39;Mapping&#39;</span><span class="p">,</span> <span class="s">&#39;Reads&#39;</span><span class="p">)</span>

<span class="c1"># calculate the fraction of mapped reads  </span>
ReadsFraction <span class="o">&lt;-</span> ddply<span class="p">(</span>  
MeltedReadCount<span class="p">,</span>  
<span class="m">.</span><span class="p">(</span>BAM<span class="p">),</span>  
summarise<span class="p">,</span>  
Count.Fraction <span class="o">=</span> Reads <span class="o">/</span> <span class="kp">sum</span><span class="p">(</span>Reads<span class="p">)</span>  
<span class="p">)</span>

<span class="c1"># sort the data frame and add fraction to the data frame  </span>
to_graph <span class="o">&lt;-</span> <span class="kp">cbind</span><span class="p">(</span>arrange<span class="p">(</span>MeltedReadCount<span class="p">,</span> BAM<span class="p">),</span> fraction <span class="o">=</span> ReadsFraction<span class="o">$</span>Count.Fraction<span class="p">)</span>

<span class="c1"># Now all we have to do is plot the data  </span>
gp <span class="o">&lt;-</span> ggplot<span class="p">(</span>data<span class="o">=</span>to_graph<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>BAM<span class="p">,</span> y<span class="o">=</span>Reads<span class="p">,</span> fill<span class="o">=</span>Mapping<span class="p">))</span> <span class="o">+</span>  
geom_bar<span class="p">(</span>stat<span class="o">=</span><span class="s">&quot;identity&quot;</span><span class="p">,</span>position <span class="o">=</span> <span class="s">&quot;stack&quot;</span><span class="p">)</span> <span class="o">+</span>  
geom_text<span class="p">(</span>aes<span class="p">(</span>label<span class="o">=</span><span class="kp">paste</span><span class="p">(</span><span class="kp">round</span><span class="p">(</span>fraction<span class="o">*</span><span class="m">100</span><span class="p">),</span><span class="s">&quot;%&quot;</span><span class="p">,</span> sep<span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)),</span>size <span class="o">=</span> <span class="m">3</span><span class="p">,</span>vjust<span class="o">=</span><span class="m">0</span><span class="p">,</span>position<span class="o">=</span><span class="s">&quot;stack&quot;</span><span class="p">)</span> <span class="o">+</span>  
opts<span class="p">(</span>axis.text.x<span class="o">=</span>theme_text<span class="p">(</span>angle<span class="o">=</span><span class="m">90</span><span class="p">))</span>

pdf<span class="p">(</span><span class="s">&quot;MappedReads.pdf&quot;</span><span class="p">)</span>  
gp  
dev.off<span class="p">()</span></code></pre></div>

<p>To execute all you have to is to go to the folder that contains the .bam files and excute from the shell:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Rscript ~/bin/CountMappedReads.r</code></pre></div>

<p>This is how the plot looks like:</p>

<p><a href="http://movingtothedarkside.files.wordpress.com/2012/10/mappedreads.png"><img src="assets/mappedreads.png?w=300" alt=""></a></p>

<p>This of course very simple, which also means very easy to change for ones specific needs, but serves the purpose of having quick visual information on how data mapped and perhaps present in group meetings. That said, never underestimate the power of visual information and one of the many beauties of ggplot is that the plots can be customized to exhaustion (I&#39;ll update this plot soonish to include the % mapping: UPDATED).</p>

<p>This simple plot contains a lot of useful information: (i) How many reads we collected; (ii) how many were mapped (the total numbers are visible in the Y-axis); (iii) visual information on the proportion of mapped reads; and just in case, (iv) also the actual proportion of mapped and unmapped reads. And this for 12 mapped files!</p>

  </article>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'adomingues-blog-io';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Moving To The Dark Side</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Moving To The Dark Side</li>
          <li><a href="mailto:amjdomingues@gmail.com">amjdomingues@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/adomingues">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">adomingues</span>
            </a>
          </li>
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text"></p>
      </div>
    </div>

  </div>

</footer>


  </body>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-60277379-1', 'auto');
  ga('send', 'pageview');

</script>


</html>
